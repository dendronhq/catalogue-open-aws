<!DOCTYPE html>

<html lang="en-US"><head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  
  <title>Load Balancers - undefined</title>
  

  <link
    rel="shortcut icon"
    href="https://aws.dendron.so/favicon.ico"
    type="image/x-icon"
  />
  <link
    rel="stylesheet"
    href="https://aws.dendron.so/assets/css/just-the-docs-default.css"
  />
  <script
    type="text/javascript"
    src="https://aws.dendron.so/assets/js/just-the-docs.js"
  ></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/themes/prism.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
    integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X"
    crossorigin="anonymous"
  />
  <script
    type="text/javascript"
    src="https://aws.dendron.so/assets/js/vendor/lunr.min.js"
  ></script>
  
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   
  
<meta name="description" content="Personal knowledge space">
<meta name="author" content="">

<link rel="canonical" href="https://aws.dendron.so/notes/load-balancers.html">

<meta property="og:type" content="article">
<meta property="og:url" content="https://aws.dendron.so/notes/load-balancers.html">
<meta property="og:description" content="Personal knowledge space">
<meta property="og:image" content="https://aws.dendron.soundefined">

<meta name="twitter:card" content="summary">

<meta name="twitter:url" content="https://aws.dendron.so/notes/load-balancers.html">
<meta name="twitter:description" content="Personal knowledge space">
<meta name="twitter:image" content="https://aws.dendron.soundefined">


  <meta property="og:title" content="Load Balancers - undefined" />
  <meta name="twitter:title" content="Load Balancers - undefined" />
  
</head>


<body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
      <symbol id="svg-link" viewBox="0 0 24 24">
        <title>Link</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
        </svg>
      </symbol>
      <symbol id="svg-search" viewBox="0 0 24 24">
        <title>Search</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
          <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </symbol>
      <symbol id="svg-menu" viewBox="0 0 24 24">
        <title>Menu</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
          <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </symbol>
      <symbol id="svg-arrow-right" viewBox="0 0 24 24">
        <title>Expand</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </symbol>
      <symbol id="svg-doc" viewBox="0 0 24 24">
        <title>Document</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file">
          <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline>
        </svg>
      </symbol>
    </svg>

    <div class="side-bar">
      <div class="site-header">
        <a href="https://aws.dendron.so" class="site-title lh-tight">
  

 </a>
        <a href="#" id="menu-button" class="site-button">
          <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg>
        </a>
      </div>

      <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
      </nav>
      <footer class="site-footer">
        üå± with üíï using <a href="https://www.dendron.so/"> Dendron üå≤ </a>
      </footer>
    </div>
    <div class="main" id="top">
        <div id="main-header" class="main-header">
          
            <div class="search">
              <div class="search-input-wrap">
                <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search " aria-label="Search " autocomplete="off">
                <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label>
              </div>
              <div id="search-results" class="search-results"></div>
            </div>
          
          
    </div>
    <div id="main-content-wrap" class="main-content-wrap">
      
        
          <nav aria-label="Breadcrumb" class="breadcrumb-nav">
            <ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="https://aws.dendron.so">Home</a></li><li class="breadcrumb-nav-list-item"><a href="https://aws.dendron.so/notes/1f759d8c-cca7-4fc4-9aa2-6dbf6e596abf.html">Services</a></li><li class="breadcrumb-nav-list-item">Load Balancers</li></ol>
          </nav>
        
      
      <div id="main-content" class="main-content" role="main">

        
        

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

        

        <script>
          $(function () {
            $('[data-toggle="popover"]').popover({html: true})
          })
        </script>

        

<div id="main" role="main">

  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Load Balancers">
    
    <meta itemprop="datePublished" content="1969-12-31T16:00:00+00:00">
    <meta itemprop="dateModified" content="1969-12-31T16:00:00+00:00">

    <div class="page__inner-wrap">

      

      <section class="page__content" itemprop="text">

        

        <h1 id="load-balancers"><a aria-hidden="true" class="anchor-heading" href="#load-balancers"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Load Balancers</h1>
<h3 id="load-balancer-basics"><a aria-hidden="true" class="anchor-heading" href="#load-balancer-basics"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Load Balancer Basics</h3>
<ul>
<li>AWS has 3 load balancing products - ‚ÄúClassic Load Balancers‚Äù (CLBs), ‚ÄúApplication Load Balancers‚Äù (ALBs), and "Network Load Balancers" (NLB).</li>
<li>Before the introduction of ALBs, ‚ÄúClassic Load Balancers‚Äù were known as ‚ÄúElastic Load Balancers‚Äù (ELBs), so older documentation, tooling, and blog posts may still reference ‚ÄúELBs‚Äù.</li>
<li>CLBs have been around since 2009, ALBs in 2016, NLBs were added in 2017 to AWS.</li>
<li>CLBs support TCP and HTTP load balancing. ALBs support HTTP load balancing only. NLBs support TCP layer 4 load balancing.</li>
<li>CLBs and ALBs can optionally handle termination for a single SSL certificate.</li>
<li>All can optionally perform active health checks of instances and remove them from the destination pool if they become unhealthy.</li>
<li>CLBs don't support complex / rule-based routing. ALBs support a (currently small) set of rule-based routing features. NLBs have most extensive routing options.</li>
<li>CLBs can only forward traffic to a single globally configured port on destination instances, while ALBs can forward to ports that are configured on a per-instance basis, better supporting routing to services on shared clusters with dynamic port assignment (like ECS or Mesos). NLBs support multiple ports on same IP; registering targets by IP address, including targets outside the VPC for the load balancer; ECS can select unused port for scheduling a task then register a target group using this port.</li>
<li>CLBs are supported in EC2 Classic as well as in VPCs while ALBs are supported in VPCs only.</li>
<li>ALBs can target groups of instances and IP based targets in the RFC1918 ranges allowing you to use on premise destinations via VPN or Direct Connect.</li>
</ul>
<h3 id="load-balancer-tips"><a aria-hidden="true" class="anchor-heading" href="#load-balancer-tips"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Load Balancer Tips</h3>
<ul>
<li>If you don‚Äôt have opinions on your load balancing up front, and don‚Äôt have complex load balancing needs like application-specific routing of requests, it‚Äôs reasonable just to use a CLB or ALB for load balancing instead.</li>
<li>Even if you don‚Äôt want to think about load balancing at all, because your architecture is so simple (say, just one server), put a load balancer in front of it anyway. This gives you more flexibility when upgrading, since you won‚Äôt have to change any DNS settings that will be slow to propagate, and also it lets you do a few things like terminate SSL more easily.</li>
<li><strong>CLBs and ALBs have many IPs:</strong> Internally, an AWS load balancer is simply a collection of individual software load balancers hosted within EC2, with DNS load balancing traffic among them. The pool can contain many IPs, at least one per availability zone, and depending on traffic levels. They also support SSL termination, which is very convenient.</li>
<li><strong>Scaling:</strong> CLBs and ALBs can scale to very high throughput, but scaling up is not instantaneous. If you‚Äôre expecting to be hit with a lot of traffic suddenly, it can make sense to load test them so they scale up in advance. You can also <a href="http://aws.amazon.com/articles/1636185810492479">contact Amazon</a> and have them ‚Äúpre-warm‚Äù the load balancer.</li>
<li><strong>Client IPs:</strong> In general, if servers want to know true client IP addresses, load balancers must forward this information somehow. CLBs add the standard <a href="https://en.wikipedia.org/wiki/X-Forwarded-For">X-Forwarded-For</a> header. When using a CLB as an HTTP load balancer, it‚Äôs possible to get the client‚Äôs IP address from this.</li>
<li><strong>Using load balancers when deploying:</strong> One common pattern is to swap instances in the load balancer after spinning up a new stack with your latest version, keep old stack running for one or two hours, and either flip back to old stack in case of problems or tear it down.</li>
<li><strong>Rotating Certificates while retaining ARN:</strong> Rotating IAM Server Certificates can be difficult as the standard practice is to upload a new one then update all resources with the new ARN. You can however retain the same ARN using the <code>update-certificate</code> call with the following process:</li>
</ul>
<ol>
<li>Upload a new IAM Server Certificate with a unique name (e.g fuzzy.com.new)</li>
<li>Rename the existing IAM Server Certificate (e.g fuzzy.com to fuzzy.com.expired)</li>
<li>Rename the new IAM Server Certificate to the name of the previously existing certificate (e.g fuzzy.com.new to fuzzy.com)</li>
<li>Jiggle the CLB/ALB Listener to pick up the change:
<ul>
<li>ALB: Invoke modify-listener with the existing details for the ALB Listener</li>
<li>CLB: Invoke create-load-balancer-listeners with the existing details for the CLB listener</li>
</ul>
</li>
</ol>
<h3 id="load-balancer-gotchas-and-limitations"><a aria-hidden="true" class="anchor-heading" href="#load-balancer-gotchas-and-limitations"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Load Balancer Gotchas and Limitations</h3>
<ul>
<li>‚ùóCLBs and ALBs have <strong>no fixed external IP</strong> that all clients see. For most consumer apps this doesn‚Äôt matter, but enterprise customers of yours may want this. IPs will be different for each user, and will vary unpredictably for a single client over time (within the standard <a href="http://docs.aws.amazon.com/general/latest/gr/aws-ip-ranges.html">EC2 IP ranges</a>). And similarly, never resolve a CLB name to an IP and put it as the value of an A record ‚Äî it will work for a while, then break!</li>
<li>‚ùóSome web clients or reverse proxies cache DNS lookups for a long time, which is problematic for CLBs and ALBs, since they change their IPs. This means after a few minutes, hours, or days, your client will stop working, unless you disable DNS caching. Watch out for <a href="http://docs.oracle.com/javase/8/docs/api/java/net/InetAddress.html">Java‚Äôs settings</a> and be sure to <a href="http://docs.aws.amazon.com/AWSSdkDocsJava/latest/DeveloperGuide/java-dg-jvm-ttl.html">adjust them properly</a>. Another example is nginx as a reverse proxy, which <a href="https://www.jethrocarr.com/2013/11/02/nginx-reverse-proxies-and-dns-resolution/">normally resolves backends only at start-up</a> (although there is <a href="https://tenzer.dk/nginx-with-dynamic-upstreams/">a way to get around this</a>).</li>
<li>‚ùóIt‚Äôs not unheard of for IPs to be recycled between customers without a long cool-off period. So as a client, if you cache an IP and are not using SSL (to verify the server), you might get not just errors, but responses from completely different services or companies!</li>
<li>üî∏As an operator of a service behind a CLB or ALB, the latter phenomenon means you can also see puzzling or erroneous requests by clients of other companies. This is most common with clients using back-end APIs (since web browsers typically cache for a limited period).</li>
<li>‚ùóCLBs and ALBs take time to scale up, it does not handle sudden spikes in traffic well. Therefore, if you anticipate a spike, you need to ‚Äúpre-warm‚Äù the load balancer by gradually sending an increasing amount of traffic.</li>
<li>‚ùóTune your healthchecks carefully ‚Äî if you are too aggressive about deciding when to remove an instance and conservative about adding it back into the pool, the service that your load balancer is fronting may become inaccessible for seconds or minutes at a time. Be extra careful about this when an autoscaler is configured to terminate instances that are marked as being unhealthy by a managed load balancer.</li>
<li>‚ùóCLB HTTPS listeners don't support Server Name Indication (SNI). If you need SNI, you can work around this limitation by either providing a certificate with Subject Alternative Names (SANs) or by using TCP listeners and terminating SSL at your backend.</li>
<li>üî∏ There is a limit on the number of ALBs, CLBs and NLBs per region (separately). As of late 2017, the default limit for each is 20 per region. These limits can be easily raised for ALB and CLB, but AWS is quite reluctant to raise the limit on NLBs.</li>
<li>üî∏ If using a Network Load Balancer (NLB) then EC2 clients cannot connect to an NLB that resides in another VPC (VPC Peering) or AWS managed VPN unless the EC2 client is a C5, i3.metal or M5 instance type. For VPC peering, both VPCs must be in the same region. See <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/network/load-balancer-troubleshooting.html#target-not-in-service">Troubleshooting</a>.</li>
</ul><span id="navId" data="load-balancers"></span>

                
      </section>

      
    </div>

    
  </article>

  
  
</div>


        
          <hr>
          <footer>
            
            

            
                
              </div>
          </footer>
        
    </div>
</div>


  

  <div class="search-overlay"></div>

</div>
</body>
</html>
